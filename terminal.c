#include <terminal.h>
#include <ports.h>

#define VGA_BUFFER 0xB8000;

#define COLOR(bg,fg) bg << 4 | fg;
#define VGA_ENTRY(c,color) color << 8 | (uint8_t)c

static const uint8_t VGA_WIDTH = 80, VGA_HEIGHT = 25;

uint8_t terminal_color = COLOR(VGA_COLOR_BLACK, VGA_COLOR_LIGHT_GREY);
uint8_t terminal_row, terminal_column;

uint32_t* vesa_buffer;

uint8_t font[256][16] = {
    {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
    {56, 56, 56, 56, 56, 56, 56, 56, 56, 16, 0, 56, 56, 56, 0, 0},
	{102, 102, 102, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{16, 17, 51, 254, 115, 38, 100, 68, 76, 255, 72, 72, 144, 144, 128, 0},
	{12, 30, 58, 40, 40, 48, 24, 28, 22, 19, 17, 19, 54, 248, 32, 32},
	{49, 211, 178, 166, 236, 8, 24, 16, 48, 35, 109, 201, 145, 147, 30, 0},
	{30, 50, 34, 70, 76, 88, 80, 112, 98, 98, 230, 188, 152, 152, 255, 0},
	{48, 48, 48, 48, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 12, 24, 16, 48, 32, 32, 96, 64, 64, 64, 96, 32, 56, 0, 0},
	{16, 24, 12, 6, 2, 2, 2, 3, 1, 3, 2, 2, 6, 12, 120, 64},
	{32, 43, 62, 24, 120, 60, 36, 32, 32, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 16, 16, 16, 16, 255, 16, 16, 16, 16, 24, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 24, 56, 56, 56, 8, 24, 16, 112, 64, 0},
	{0, 0, 0, 0, 0, 0, 120, 14, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56, 56, 56, 24, 0, 0},
	{0, 0, 0, 2, 6, 4, 12, 24, 16, 48, 32, 32, 0, 0, 0, 0},
    {48, 248, 140, 134, 130, 131, 129, 129, 129, 129, 129, 195, 66, 102, 56, 16},
    {24, 24, 56, 104, 136, 8, 8, 8, 8, 8, 8, 8, 12, 4, 255, 0},
    {56, 108, 6, 2, 2, 2, 2, 4, 12, 24, 120, 200, 141, 135, 134, 0},
    {56, 108, 6, 6, 4, 12, 56, 24, 12, 6, 2, 2, 6, 60, 48, 0},
    {8, 16, 48, 32, 96, 64, 196, 159, 244, 12, 8, 8, 8, 8, 8, 0},
    {49, 63, 32, 32, 32, 96, 64, 120, 76, 4, 4, 4, 4, 60, 0, 0},
    {24, 46, 66, 64, 128, 128, 128, 128, 188, 230, 66, 102, 36, 60, 0, 0},
    {0, 115, 222, 2, 6, 4, 4, 63, 12, 8, 8, 24, 16, 16, 16, 0},
    {30, 50, 38, 68, 108, 40, 56, 28, 54, 34, 35, 33, 35, 54, 28, 0},
    {28, 118, 66, 67, 65, 65, 127, 49, 2, 2, 6, 12, 8, 16, 96, 192},
    {0, 0, 56, 60, 28, 0, 0, 0, 0, 56, 120, 56, 0, 0, 0, 0},
	{0, 0, 60, 62, 30, 0, 0, 16, 56, 56, 56, 56, 24, 16, 48, 32},
	{0, 6, 12, 24, 112, 192, 192, 48, 24, 12, 6, 2, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 254, 0, 0, 15, 120, 0, 0, 0, 0, 0, 0},
	{0, 0, 96, 56, 12, 7, 1, 3, 30, 112, 192, 0, 0, 0, 0, 0},
	{60, 100, 4, 4, 4, 12, 24, 16, 16, 48, 0, 0, 0, 56, 56, 48},
	{0, 0, 28, 118, 194, 130, 130, 186, 170, 174, 188, 128, 128, 224, 62, 0},
	{0, 8, 24, 24, 24, 24, 56, 40, 40, 40, 124, 68, 198, 130, 130, 0},
	{124, 70, 66, 67, 67, 66, 70, 56, 44, 36, 38, 34, 166, 252, 32, 0},
	{0, 28, 48, 96, 64, 64, 64, 64, 64, 64, 64, 32, 34, 62, 0, 0},
    {240, 92, 68, 66, 66, 67, 65, 65, 65, 65, 67, 70, 92, 112, 96, 0},
	{0, 62, 96, 64, 192, 128, 206, 120, 64, 64, 64, 64, 64, 64, 126, 99},
	{0, 63, 32, 96, 64, 64, 64, 254, 64, 64, 64, 64, 64, 64, 64, 96},
	{28, 54, 66, 64, 64, 192, 128, 129, 143, 134, 130, 194, 66, 102, 60, 24},
	{64, 66, 66, 66, 66, 66, 126, 66, 66, 66, 66, 66, 66, 134, 128, 0},
	{62, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 18, 254},
	{0, 62, 2, 2, 2, 2, 2, 2, 2, 2, 2, 6, 4, 68, 120, 0},
	{0, 64, 64, 134, 140, 152, 176, 224, 192, 224, 176, 156, 134, 131, 128, 0},
	{0, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 127, 64},
	{0, 0, 0, 18, 18, 54, 54, 54, 118, 94, 90, 218, 154, 0, 0, 0},
	{0, 2, 98, 98, 114, 82, 82, 90, 74, 78, 70, 70, 66, 0, 0, 0},
	{0, 0, 56, 110, 66, 66, 66, 66, 66, 66, 98, 38, 52, 28, 0, 0},
	{126, 66, 67, 65, 193, 131, 130, 254, 128, 128, 128, 128, 128, 128, 128, 128},
	{0, 15, 27, 49, 33, 99, 66, 66, 66, 198, 156, 140, 140, 206, 90, 112},
	{0, 120, 72, 200, 136, 136, 152, 240, 224, 160, 176, 152, 140, 132, 130, 128},
	{0, 62, 96, 64, 128, 192, 96, 56, 8, 12, 4, 4, 4, 124, 64, 0},
	{255, 16, 16, 16, 16, 16, 16, 8, 8, 8, 8, 8, 8, 24, 16, 0},
	{0, 129, 129, 129, 129, 129, 129, 129, 129, 131, 66, 70, 68, 68, 104, 56},
	{0, 65, 65, 97, 33, 35, 34, 18, 18, 18, 30, 12, 12, 12, 8, 0},
	{3, 130, 130, 146, 218, 90, 90, 90, 90, 126, 102, 36, 36, 36, 0, 0},
	{129, 129, 195, 70, 36, 44, 56, 24, 16, 56, 40, 108, 68, 66, 130, 129},
	{192, 66, 66, 102, 36, 36, 44, 56, 24, 24, 16, 16, 16, 16, 16, 16},
	{255, 1, 1, 3, 2, 6, 12, 8, 24, 48, 32, 64, 252, 231, 128, 0},
	{0, 240, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 240, 0},
	{64, 64, 96, 32, 48, 16, 24, 8, 4, 4, 6, 3, 1, 1, 0, 0},
	{0, 31, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 31, 0},
	{24, 56, 44, 100, 68, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 255},
	{8, 12, 6, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 60, 108, 76, 72, 92, 119, 0, 0, 0},
	{0, 0, 0, 96, 64, 64, 64, 64, 64, 124, 100, 44, 56, 16, 0, 0},
	{0, 0, 0, 0, 0, 0, 12, 24, 48, 32, 32, 60, 0, 0, 0, 0},
	{0, 0, 4, 4, 4, 12, 12, 12, 60, 108, 72, 74, 126, 0, 0, 0},
	{0, 0, 0, 0, 0, 62, 98, 68, 120, 64, 96, 56, 0, 0, 0, 0},
	{0, 3, 7, 13, 9, 9, 19, 22, 60, 16, 32, 96, 120, 32, 32, 0},
	{0, 0, 8, 56, 104, 72, 72, 88, 123, 62, 56, 120, 80, 112, 96, 0},
	{0, 0, 32, 32, 32, 32, 32, 56, 120, 108, 100, 100, 68, 68, 0, 0},
	{0, 8, 8, 0, 0, 0, 8, 24, 56, 104, 8, 8, 14, 6, 0, 0},
	{0, 24, 24, 0, 24, 56, 105, 11, 10, 14, 24, 56, 40, 120, 48, 0},
	{0, 0, 32, 32, 32, 64, 68, 76, 120, 96, 96, 96, 80, 88, 76, 0},
	{0, 0, 64, 64, 64, 64, 64, 64, 64, 64, 70, 68, 68, 40, 56, 0},
	{0, 0, 0, 0, 0, 0, 16, 51, 55, 54, 126, 91, 217, 145, 0, 0},
	{0, 0, 0, 0, 0, 49, 49, 51, 50, 126, 76, 76, 76, 64, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 12, 244, 134, 130, 134, 204, 120, 0, 0},
	{0, 0, 0, 0, 8, 60, 52, 116, 228, 164, 37, 35, 96, 64, 64, 0},
	{0, 0, 0, 0, 0, 60, 100, 68, 76, 220, 124, 9, 15, 28, 24, 16},
	{0, 0, 0, 0, 0, 108, 253, 55, 32, 96, 64, 64, 64, 0, 0, 0},
	{0, 0, 0, 0, 0, 4, 28, 116, 198, 2, 2, 14, 120, 0, 0, 0},
	{0, 0, 32, 32, 62, 240, 32, 32, 32, 32, 32, 32, 32, 44, 56, 0},
	{0, 0, 0, 0, 0, 0, 0, 66, 66, 66, 70, 78, 76, 127, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 2, 70, 68, 108, 40, 48, 16, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 0, 136, 153, 217, 127, 102, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 32, 34, 54, 28, 56, 100, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 35, 34, 38, 60, 12, 8, 24, 16, 16},
	{0, 0, 0, 0, 0, 0, 0, 14, 242, 6, 4, 12, 24, 63, 224, 0},
	{0, 24, 48, 32, 32, 32, 32, 32, 224, 128, 64, 64, 64, 64, 104, 56},
	{0, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 0},
    {48, 24, 8, 12, 4, 12, 8, 14, 2, 6, 4, 4, 4, 8, 56, 32},
	{0, 0, 0, 0, 0, 112, 217, 137, 15, 6, 0, 0, 0, 0, 0, 0},
	{}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
    {},
    {0, 0, 8, 12, 28, 20, 54, 62, 98, 66, 70, 196, 4, 4, 4, 0},
	{},
    {0, 0, 64, 66, 68, 76, 88, 112, 96, 192, 192, 64, 64, 127, 0, 0},
	{},
    {},
    {56, 32, 28, 54, 96, 64, 64, 96, 48, 24, 8, 8, 8, 8, 120, 0},
	{},
    {},
    {},
    {},
    {},
    {30, 0, 255, 2, 6, 4, 4, 8, 24, 16, 48, 96, 192, 252, 199, 0},
    {},
    {},
    {24, 24, 0, 255, 3, 6, 4, 4, 12, 8, 24, 16, 48, 96, 64, 255},
	{},
    {0, 0, 0, 0, 0, 0, 60, 228, 132, 132, 204, 127, 6, 4, 6, 2},
	{},
    {0, 0, 0, 16, 16, 16, 28, 56, 240, 16, 32, 32, 32, 34, 62, 0},
	{},
    {},
    {0, 7, 12, 0, 0, 8, 28, 52, 100, 4, 4, 4, 56, 0, 0, 0},
	{},
    {},
    {},
    {},
    {},
    {0, 3, 6, 12, 24, 0, 127, 3, 6, 12, 56, 96, 126, 0, 0, 0},
	{},
    {},
    {0, 0, 24, 24, 0, 0, 126, 126, 12, 24, 48, 96, 254, 0, 0, 0},
	{},
    {},
    {},
    {},
    {},
    {},
    {12, 56, 0, 30, 33, 96, 64, 64, 64, 64, 64, 96, 32, 56, 12, 0},
	{},
    {},
    {},
    {0, 0, 126, 64, 64, 192, 128, 248, 143, 128, 128, 128, 128, 254, 12, 8},
	{},
    {},
    {},
    {},
    {},
    {},
    {3, 12, 72, 97, 99, 114, 90, 138, 142, 134, 134, 134, 130, 130, 130, 0},
	{},
    {12, 24, 0, 31, 49, 97, 65, 65, 65, 65, 65, 65, 54, 28, 0, 0},
	{}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, 
    {6, 12, 48, 0, 0, 124, 198, 130, 128, 128, 128, 128, 192, 126, 0, 0},
	{},
    {},
    {},
    {0, 0, 0, 0, 62, 98, 66, 70, 76, 120, 64, 126, 15, 24, 16, 16},
	{},
    {},
    {},
    {},
    {},
    {},
    {2, 6, 12, 8, 0, 30, 27, 25, 17, 51, 34, 38, 68, 68, 0, 0},
	{},
    {0, 3, 6, 28, 16, 0, 60, 38, 98, 66, 66, 70, 124, 0, 0, 0},
    };

static inline uint8_t color(enum vga_color bg, enum vga_color fg)
{
    return COLOR(bg, fg);
}

inline void set_color(enum vga_color bg, enum vga_color fg)
{
    terminal_color = COLOR(bg, fg);
}

void put_pixel(int x, int y, uint32_t color)
{
    vesa_buffer[y*640 + x] = color; 
}

void put_char_at(uint8_t c, uint8_t color, uint8_t char_y, uint8_t char_x)
{
    //uint16_t* buffer = (uint16_t*) VGA_BUFFER;
    //buffer[y * VGA_WIDTH + x] = VGA_ENTRY(c, color);
    (void)color;
    for(int y = 0; y < 16; y++)
        for(int x = 0; x < 8; x++)
            put_pixel(char_x * 8 + x, char_y * 16 + y, 0x0000FFFF * (font[c][y] & (1 << (7 - x))));
}

void set_cursor(uint8_t y, uint8_t x)
{
    put_char_at('_', 0, y, x);
}

void terminal_initialize(uint32_t buffer)
{   
    vesa_buffer = (uint32_t*)buffer;
    for(uint8_t y = 0; y < VGA_HEIGHT; y++)
        for(uint8_t x = 0; x < VGA_WIDTH; x++)
            put_char_at(1, terminal_color, y, x);
    
    terminal_row = terminal_column = 0;
    set_cursor(terminal_row, terminal_column);
}

void update_cursor()
{
    set_cursor(terminal_row, terminal_column);
}