#include <terminal.h>
#include <graphics.h>
#include <stdio.h>
#include <gdt.h>
#include <idt.h>
#include <pci.h>
#include <ps2.h>
#include <stdlib.h>
#include <windows.h>

uint8_t ikona[] = {
    0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00 , 0xFF , 0xFF , 0xFF , 0x00
};

#include <list.h>

void sranko()
{
    struct list_struct *list = list_create();

    int p1= 0x23, p2= 0x45, p3 = 5;

    list_add(list, &p1);
    list_add(list, &p2);
    list_add(list, &p3);

    printf("%1", list->size);

    while(1);
}

void kernel_main(uint32_t* address)
{
    set_color(VGA_COLOR_BLACK, VGA_COLOR_LIGHT_BLUE);
    terminal_initialize(address[22], address[25], address[26]);
    graphics_initialize((uint32_t*)address[22], address[25], address[26]);

    printf("MDOS\n");
    printf("----\n");

    
    gdt_init();
    idt_init();
    pci_enum();
    
    ps2_controller_init();


    sranko();

    for(uint32_t y = 0; y < screen_height; y++)
        for(uint32_t x = 0; x < screen_width; x++)
            back_buffer[y * screen_width + x] = 0x008080;

    for(uint32_t y = screen_height - 28; y < screen_height; y++)
        for(uint32_t x = 0; x < screen_width; x++)
            back_buffer[y * screen_width + x] = 0xc0c0c0;
    
    for(uint32_t x = 0; x < screen_width; x++)
            back_buffer[(screen_height - 27) * screen_width + x] = 0xFFFFFF;

    button(3, screen_height - 23, 51, 19);

    for(int y = 0; y < 16; y++)
        for(int x = 0; x < 16; x++)
        {
            if(((uint32_t*)ikona)[(15- y) * 16 + x] != 0xffffff)
                back_buffer[(y + screen_height - 21) * screen_width + x + 6] = ((uint32_t*)ikona)[(15- y) * 16 + x];
        }

    
    update_rect(0, 0, screen_width, screen_height);

    struct window_struct *win1 = window_create(10, 10, 300, 200);
    struct window_struct *win2 = window_create(100, 150, 400, 400);
    struct window_struct *win3 = window_create(200, 100, 200, 600);
    window_draw(win1);
    window_draw(win2);
    window_draw(win3);

    asm("hlt");

    update_rect(0, 0, screen_width, screen_height);

    // while(1)
    // {
    //     char znok;
    //     scanf("%c", &znok);
    // }

    










    

    // int dx = 1, dy = 1;
    // for(;;)
    // {
    //     czarny();
    //     ax += dx;
    //     ay += dy;
    //     if(ay > height - 10)
    //         dy = -1;
    //     else if(ay < 1)
    //         dy = 1;

    //     if(ax > width - 10)
    //         dx = -1;
    //     else if(ax < 1)
    //         dx = 1;
    //     czerwony();
    //     for(int i = 0; i < 1000000; i++);
    // }   

    //thread_create(blink, "BLINK");

    // char* line = malloc(1024);
    // while(1)
    // {
    //     printf("mdominiak@client:~/MDOS$ ");
    //     int ile = getline(&line);
    //     if(ile > 1)
    //     {
    //         if(strncmp(line, "color", 5) == 0)
    //             terminal_change_color();
    //         else if(strncmp(line, "echo off", 8) == 0)
    //             terminal_echo = false;
    //         else if(strncmp(line, "echo on", 7) == 0)
    //             terminal_echo = true;
    //         else if(strncmp(line, "vim", 3) == 0)
    //             vim_main();
    //         else if(strncmp(line, "clear", 5) == 0)
    //             terminal_clear();
    //         else if(strncmp(line, "disable", 7) == 0)
    //             disable_cursor();
    //         else if(strncmp(line, "enable", 6) == 0)
    //             enable_cursor();
    //         else
    //         {
    //         for(int i = 0; i < ile - 1; i++)
    //             putc(line[i]);
    //         puts(": nie znam takiej komendy\n");
    //         }
    //     }  
    // }

    while(1)
        asm("hlt");
}